<!-- WINIX rail -->
<section id="winix-rail-root" class="w-full py-12">
  <div class="w-full">
    <header class="mb-6 px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-semibold text-primary">Explore WINIX</h2>
      <p class="text-sm text-secondary mt-1">Premium HEPA purifiers</p>
    </header>

    <!-- skeleton while IO not fired -->
    <div *ngIf="!inView"
         class="flex overflow-x-auto gap-6 px-4 sm:px-6 lg:px-8 [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden">
      <div *ngFor="let _ of [1,2,3,4,5]"
           class="flex-none w-72 h-[24rem] rounded-2xl border border-muted bg-surface shadow-soft p-4">
        <div class="h-full w-full rounded-xl bg-[hsl(var(--color-border))] animate-pulse"></div>
      </div>
    </div>

    <!-- Enhanced continuous scrolling rail -->
    <div *ngIf="inView" class="relative overflow-hidden">
      <div
        #railEl
        role="list"
        aria-label="Product carousel (auto-scrolls; hover to pause)"
        class="flex gap-6 px-4 sm:px-6 lg:px-8 animate-scroll-horizontal
               [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
        [class.paused]="paused">

        <!-- First set of cards -->
        <article
          *ngFor="let p of products; let i = index; trackBy: trackById"
          role="listitem"
          tabindex="0"
          [attr.aria-label]="p.title"
          class="flex-none w-72 sm:w-80 outline-none"
          (mouseenter)="pauseScroll()"
          (mouseleave)="resumeScroll()">

          <!-- whole card navigates -->
          <a [routerLink]="['/product', p.slug]"
             class="block h-[24rem] rounded-2xl shadow-soft border border-muted bg-white text-gray-900 relative overflow-hidden hover:shadow-lg transition-shadow duration-300">

            <!-- text -->
            <div class="px-5 pt-4 text-center">
              <p class="text-[11px] tracking-wide text-gray-500">
                {{ p.tagline || 'Premium HEPA purifier' }}
              </p>
              <h3 class="mt-0.5 text-lg font-semibold leading-snug">
                {{ p.title }}
              </h3>
            </div>

            <!-- image -->
            <div class="mx-auto mt-4 h-[12.5rem] sm:h-[13rem] w-[85%]">
              <div *ngIf="imageLoading[i]" class="absolute inset-0 pointer-events-none">
                <div class="mx-auto mt-2 h-2 w-1/2 animate-pulse rounded-full bg-gray-200"></div>
              </div>

              <img
                class="h-full w-full object-contain object-center drop-shadow-sm transition-transform duration-300 hover:scale-105"
                [class.opacity-0]="imageLoading[i]"
                [src]="p.imageSrc"
                [alt]="p.title"
                (load)="onImageLoad(i)"
                loading="lazy"
                decoding="async"
                [attr.fetchpriority]="i < 2 ? 'high' : 'low'"
              />
            </div>

            <!-- tiny rating bottom-right -->
            <div class="absolute right-3 bottom-3 flex items-center space-x-1">
              <ng-container *ngFor="let s of [1,2,3,4,5]">
                <svg class="h-3 w-3"
                     [ngClass]="starFilled(p.rating, s) ? 'text-yellow-400' : 'text-gray-300'"
                     aria-hidden="true" viewBox="0 0 20 20" fill="currentColor">
                  <path
                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.035a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.035a1 1 0 00-1.176 0l-2.802 2.035c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.88 8.72c-.783-.57-.38-1.81.588-1.81H6.93a1 1 0 00.95-.69l1.07-3.292z" />
                </svg>
              </ng-container>

              <span class="ml-1 text-[11px] font-medium text-gray-700">
                {{ safeNumber(p.rating).toFixed(1) }}
              </span>
            </div>
          </a>
        </article>

        <!-- Duplicate set for seamless loop -->
        <article
          *ngFor="let p of products; let i = index; trackBy: trackById"
          role="listitem"
          tabindex="0"
          [attr.aria-label]="p.title + ' (duplicate)'"
          class="flex-none w-72 sm:w-80 outline-none"
          (mouseenter)="pauseScroll()"
          (mouseleave)="resumeScroll()">

          <!-- whole card navigates -->
          <a [routerLink]="['/product', p.slug]"
             class="block h-[24rem] rounded-2xl shadow-soft border border-muted bg-white text-gray-900 relative overflow-hidden hover:shadow-lg transition-shadow duration-300">

            <!-- text -->
            <div class="px-5 pt-4 text-center">
              <p class="text-[11px] tracking-wide text-gray-500">
                {{ p.tagline || 'Premium HEPA purifier' }}
              </p>
              <h3 class="mt-0.5 text-lg font-semibold leading-snug">
                {{ p.title }}
              </h3>
            </div>

            <!-- image -->
            <div class="mx-auto mt-4 h-[12.5rem] sm:h-[13rem] w-[85%]">
              <div *ngIf="imageLoading[i + products.length]" class="absolute inset-0 pointer-events-none">
                <div class="mx-auto mt-2 h-2 w-1/2 animate-pulse rounded-full bg-gray-200"></div>
              </div>

              <img
                class="h-full w-full object-contain object-center drop-shadow-sm transition-transform duration-300 hover:scale-105"
                [class.opacity-0]="imageLoading[i + products.length]"
                [src]="p.imageSrc"
                [alt]="p.title"
                (load)="onImageLoad(i + products.length)"
                loading="lazy"
                decoding="async"
              />
            </div>

            <!-- tiny rating bottom-right -->
            <div class="absolute right-3 bottom-3 flex items-center space-x-1">
              <ng-container *ngFor="let s of [1,2,3,4,5]">
                <svg class="h-3 w-3"
                     [ngClass]="starFilled(p.rating, s) ? 'text-yellow-400' : 'text-gray-300'"
                     aria-hidden="true" viewBox="0 0 20 20" fill="currentColor">
                  <path
                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.035a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.035a1 1 0 00-1.176 0l-2.802 2.035c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.88 8.72c-.783-.57-.38-1.81.588-1.81H6.93a1 1 0 00.95-.69l1.07-3.292z" />
                </svg>
              </ng-container>

              <span class="ml-1 text-[11px] font-medium text-gray-700">
                {{ safeNumber(p.rating).toFixed(1) }}
              </span>
            </div>
          </a>
        </article>
      </div>
    </div>
  </div>
</section>
